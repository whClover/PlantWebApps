@*

*@
@{
    @using System.Data;
    // viewdata["title"] = "external repair job history";
    bool isModEdit = ViewBag.ModEdit != null && (bool)ViewBag.ModEdit;
    string isEdit = isModEdit ? "" : "disabled";

    bool isModAdd = ViewBag.ModAdd != null && (bool)ViewBag.ModAdd;
    string isAdd = isModAdd ? "" : "disabled";
}

<script type="text/javascript">

    function showOverlay() {
        var overlay = document.createElement('div');
        overlay.className = 'overlay';

        var spinner = document.createElement('div');
        spinner.className = 'spinner';

        var text = document.createElement('div');
        text.className = 'text';
        text.innerHTML = 'Processing Data...';

        overlay.appendChild(spinner);
        overlay.appendChild(text);
        document.body.appendChild(overlay);

        setTimeout(function () {
            hideOverlay();
        }, 3000);

        return true;
    }
    function hideOverlay() {
        var overlay = document.querySelector('.overlay');
        if (overlay) {
            document.body.removeChild(overlay);
        }
    }

    // status modal
    document.addEventListener('DOMContentLoaded', function () {
        var statusInput = document.getElementById('statusInput');
        var statusSelect = document.getElementById('statusSelect');

        document.getElementById('saveStatusBtn').addEventListener('click', function () {
            var selectedOptions = Array.from(statusSelect.selectedOptions).map(option => option.value);

            statusInput.value = selectedOptions.join(', ');
        });
    });

    document.addEventListener('DOMContentLoaded', function () {

        var btnDanger = document.getElementById('statusRemove');
        var statusInput = document.getElementById('statusInput');

        btnDanger.addEventListener('click', function () {
            statusInput.value = '';
        });
    });

    function confirmDelete(id) {
        Swal.fire({
            title: 'Are you sure?',
            html: `
                                <div style="font-size: 16px; text-align: center;">
                                    <div style="margin-bottom: 10px;">
                                        Are you sure to delete the following data?
                                    </div>
                                </div>
                            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                performDelete(id);
            }
        });
    }

    function performDelete(id) {
        $.ajax({
            method: "POST",
            url: "/ExrRepairJobHistory/Delete",
            dataType: 'json',
            data: { id: id }
        }).done(function (response) {
            location.reload();
        });
    }
</script>

<form method="post" enctype="multipart/form-data" asp-controller="ExrRepairJobHistory">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">External Repair Job History</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <blockquote class="blockquote custom-blockquote blockquote-primary rounded mb-0 p-2">
                            @* <small>Total Records: @ViewBag.TotalRecords Rows</small> *@
                        </blockquote>
                    </div>
                    <div class="d-flex mb-2 align-items-center" style="gap: 5px">
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                            <i class="fa fa-filter me-2"></i> FILTER
                        </button>
                        <button type="submit" class="btn btn-sm btn-primary" formaction="/ExrRepairJobHistory/Add" @isAdd>
                            <i class="fa fa-plus me-2"></i> ADD
                        </button>
                        <div>
                            <select name="creportype" class="form-select" style="width: 160px;">
                                <option value="">*Select Export Type*</option>
                                <option value="1">Job Detail</option>
                                <option value="2">OR Request TCI</option>
                                <option value="3">OR Request LCI</option>
                                <option value="4">Inspection Detail</option>
                                <option value="5">Core Component</option>
                                <option value="6">Main Component</option>
                                <option value="7">Unit Job Detail</option>
                                <option value="8">Complete Component</option>
                                <option value="9">Warranty Report</option>
                                <option value="10">WIP Report</option>
                                <option value="11">Variance Analysis</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary" formaction="/ExrRepairJobHistory/Export" OnClick="return showOverlay();">
                            <i class="fa fa-download me-2"></i> EXPORT
                        </button>
                        <button type="submit" class="btn btn-sm btn-primary" formaction="/ComponentEvaluation/Index">
                            CE
                        </button>
                        <button type="submit" class="btn d-none btn-sm btn-primary" formaction="/JournalDetail/Index">
                            DISPATCH
                        </button>
                        <button type="submit" class="btn btn-sm btn-primary" formaction="/ExrRepairJobHistory/CreateAN">
                            CREATE AN
                        </button>
                        <div class="btn btn-primary btn-file col-1 d-flex align-items-center justify-content-center" id="btnUploadWo" name="CANFPUpload" style="max-height: 32px;">
                            Upload WO
                            <input type="file" id="uploadWo" name="uploadWo" accept=".txt, .tsv">
                        </div>
                    </div>

                    <!-- right offcanvas -->
                    <partial name="_filter.cshtml" />

                    <!-- Modal -->
                    <div class="modal fade" id="filterstatusmodal" tabindex="-1" aria-labelledby="filterstatusmodal" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="statusModal">Status</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <select class="form-select" multiple aria-label="status select" style="min-height: 135px;" id="statusSelect">
                                        <option value="C">C | Closed</option>
                                        <option value="D">D | Deleted</option>
                                        <option value="H">H | Hold</option>
                                        <option value="L">L | In Transit</option>
                                        <option value="O">O | Outstanding</option>
                                        <option value="P">P | In Progress</option>
                                        <option value="X">X | Canceled</option>
                                    </select>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="saveStatusBtn">Save changes</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (TempData.Peek("Msg") != null)
                    {
                        @section Scripts
                    {
                        <script>
                            Swal.fire({
                                title: '@TempData.Peek("Msg")',
                                    icon: '@TempData.Peek("Stat")'
                                });
                            </script>
                        }
                    }

                    <div id="tableContainer" class="table-responsive">
                        <table id="myTable" class="table datatable mb-0 table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>DELETE</th>
                                    <th>EDIT</th>
                                    <th>ID</th>
                                    <th>Prio</th>
                                    <th>Total AGE WO</th>
                                    <th>Age Waiting Qoute</th>
                                    <th>Unit Number</th>
                                    <th>Wo Alloc</th>
                                    <th>Site Alloc</th>
                                    <th>WOJob Cost</th>
                                    <th>Log Date</th>
                                    <th>PER AN</th>
                                    <th>St</th>
                                    <th>Comp Desc</th>
                                    <th>Qty</th>
                                    <th>Comp Type</th>
                                    <th>Repair Advice</th>
                                    <th>PCAM</th>
                                    <th>TCI Part No</th>
                                    <th>Supv</th>
                                    <th>Repair By</th>
                                    <th>Int WO</th>
                                    <th>WorkShop Status</th>
                                    <th>AN For Repair</th>
                                    <th>Qoute No</th>
                                    <th>Job No</th>
                                    <th>Quote Date</th>
                                    <th>OR No</th>
                                    <th>OP No</th>
                                    <th>OP Date</th>
                                    <th>Received Date</th>
                                    <th>PRF ID</th>
                                    <th>QR No</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<style>
    .btn-file {
        position: relative;
        overflow: hidden;
    }

        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: inherit;
            display: block;
        }
</style>


<script>
    $(document).ready(function () {

        LoadData()
        $('#filterButton').click(function (e) {
            e.preventDefault();
            LoadData();
        });

        function LoadData() {
            var repairType = $('#repairtypeid').val();
            var compType = $('#comptype').val();
            var statusInput = $('#statusInput').val();
            var supervisorId = $('#supervisorid').val();
            var supplierId = $('#supplierid').val();
            var cwoType = $('#cwotype').val();
            var cwoTypeValue = $('#cwotypevalue').val();
            var fdocType = $('#fdoctype').val();
            var fdocTypeValue = $('#fdoctypevalue').val();
            var ccompIdType = $('#ccompidtype').val();
            var ccompIdValue = $('#ccompidvalue').val();
            var sDate = $('#sdate').val();
            var startDate = $('#startdate').val();
            var endDate = $('#endate').val();
            var lmodBy = $('#lmodby').val();
            var lmodByValue = $('#lmodbyvalue').val();
            var reasonTypeId = $('#reasontypeid').val();
            var freasonType = $('#freasontype').val();
            var freasonValue = $('#freasonvalue').val();
            var cbDelay = $('#cbdelay').val();
            var cbDelayValue = $('#cbdelayvalue').val();
            var repairAdvice = $('#repairadvice').val();
            var toCatDesc = $('#tocatdesc').val();
            var requestP1 = $('#RequestP1').val();
            var fissNull = $('#fissnull').val();
            var pCam = $('#pcam').val();
            var sortBy = $('#sortby').val();
            var ascDesc = $('#ascdsc').val();
            var unitnumber = $('#unitnumber').val();

            // Tampilkan loading overlay
            $('#loadingOverlay').show();

            $.ajax({
                url: '@Url.Action("LoadData", "ExrRepairJobHistory")',
                type: 'GET',
                dataType: 'json',
                data: {
                    repairType: repairType,
                    compType: compType,
                    statusInput: statusInput,
                    supervisorId: supervisorId,
                    supplierId: supplierId,
                    cwoType: cwoType,
                    cwoTypeValue: cwoTypeValue,
                    fdocType: fdocType,
                    fdocTypeValue: fdocTypeValue,
                    ccompIdType: ccompIdType,
                    ccompIdValue: ccompIdValue,
                    sDate: sDate,
                    startDate: startDate,
                    endDate: endDate,
                    lmodBy: lmodBy,
                    lmodByValue: lmodByValue,
                    reasonTypeId: reasonTypeId,
                    freasonType: freasonType,
                    freasonValue: freasonValue,
                    cbDelay: cbDelay,
                    cbDelayValue: cbDelayValue,
                    repairAdvice: repairAdvice,
                    toCatDesc: toCatDesc,
                    requestP1: requestP1,
                    fissNull: fissNull,
                    pCam: pCam,
                    sortBy: sortBy,
                    ascDesc: ascDesc,
                    unitnumber: unitnumber
                },
                success: function (test) {
                    //console.log(test);
                    $('.datatable').DataTable().clear().destroy(); // Clear and destroy the existing DataTable
                    $('.datatable').DataTable({
                        searching: false,
                        lengthChange: false,
                        responsive: true,
                        pageLength: 20,
                        data: test, // The data received from the AJAX request
                        columns: [
                            { "data": "delete" },
                            { "data": "edit" },
                            { "data": "id" },
                            { "data": "totalAgeWO" },
                            { "data": "unitNumber" },
                            { "data": "offSiteWO" },
                            { "data": "woAlloc" },
                            { "data": "siteAllocName" },
                            { "data": "woJobCost" },
                            { "data": "logANReceivedDate" },
                            { "data": "logANReceivedDate" },
                            { "data": "logANSentDate" },
                            { "data": "status" },
                            { "data": "compDesc" },
                            { "data": "compQty" },
                            { "data": "compType" },
                            { "data": "repairAdvice" },
                            { "data": "pcamStatusID" },
                            { "data": "tciPartNo" },
                            { "data": "supervisorAbbr" },
                            { "data": "supplierName" },
                            { "data": "intWO" },
                            { "data": "suppForRepairANNo" },
                            { "data": "quoteNo" },
                            { "data": "jobNo" },
                            { "data": "quoteDate" },
                            { "data": "orNo" },
                            { "data": "opDate" },
                            { "data": "receivedDate" }
                        ]
                    });
                    // Sembunyikan loading overlay setelah data dimuat
                    $("#offcanvas").offcanvas("hide");
                    $('#loadingOverlay').hide();
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }

        $('#uploadWo').on('change', function () {
            console.log("clicked");

            var file = this.files[0];

            var formData = new FormData();
            formData.append("fileData", file);

            console.log("file data is", formData);

            $.ajax({
                method: "POST",
                url: "/UploadWO/Index",
                dataType: 'json',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if (response == "ok") {
                        Swal.fire("Upload WO Process Is Running", "", "info");
                    } else if (response == "error") { 
                        Swal.fire("Upload Wo Failed", "", "error");
                    }
                },
                error: function (error) {
                    // Handle error response here
                }
            });
        });


    });
</script>